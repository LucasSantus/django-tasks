{% extends 'base.html' %}

{% load bootstrap5 %}

{% block content %}
    <div class="vw-100 position-relative bg-primary" style="height: 300px;">
        <div class="position-absolute top-100 start-50 translate-middle">
            <form>
                <input type="text" class="form-control" id="search-todo" placeholder="Pesquisar...">
            </form>
        </div>
    </div>

    <div id="id_todos" class="vw-100 h-100 bg-secondary"></div>

    <!-- Button trigger modal -->
    <button type="button" class="position-absolute btn btn-primary" style="bottom: 20px; right: 20px" data-bs-toggle="modal" data-bs-target="#modal_create_todo">
        add
    </button>

    <!-- Modal -->
    <div class="modal" id="modal_create_todo" tabindex="-1" aria-labelledby="modal_create_todo_label" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body p-3">
                    <form id="id_form" method="POST">
                        {% csrf_token %}
                        {% bootstrap_form form %}

                        <button id="btn-submit" class="btn btn__custom__primary hover d-grid w-100 rounded-3 mt-1 mb-2" type="submit">Logar</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block css %}
    <style>
        .error{
            background: red !important
        }
    </style>
{% endblock %}

{% block script %}

    <!-- BEGIN: INICIALIZAÇÂO -->
        <script>
            $(document).ready(function(){

                let todos = "{{ todos | escapejs  }}";

                get_all_todos(JSON.parse(todos), "id_todos");
            });
        </script>
    <!-- END: INICIALIZAÇÂO -->

    <!-- BEGIN: VALIDAÇÃO DE USUÁRIO -->
        <script>
            $('#id_form').validate({
                rules: {
                    title: { required: true, minlength: 2 },
                    description: { required: true },
                },
                messages: {
                    title: { required: 'Preencha o campo nome', minlength: 'No mínimo 2 letras' },
                    description: { required: 'Informe o seu email' },
                },
                invalidHandler: function(event, validator) {
                    console.log("event: ", event, "validator: ", validator.errorList);
                    
                    for (var i = 0; i < validator.errorList.length; i++) {
                        if (validator.errorList[i].element.name == "id_title") {
                            $("#id_title")
                                .closest(".ctrl")
                                .addClass("has-error");
                            $("#id_title-error").show();
                        }
                        else {
                            $("#" + validator.errorList[i].element.id)
                                .closest(".ctrl")
                                .addClass("has-error");
                        }
                    }
                },
                errorPlacement: function() {},
                submitHandler: function( form ){
                    var dados = $( form ).serialize(); 

                    $.ajax({
                        type: "POST",
                        url: "{% url 'create_todo' %}",
                        data: dados,
                        success: function( response ){
                            
                            $("#id_form").trigger('reset');

                            let instance = JSON.parse(response["data"]);
                            let fields = instance[0]["fields"];

                            get_all_todos(fields, "id_todos");
                        }
                    });
                    return false;
                }
            });

            /*
            $("#id_form").submit(function (event) {
                // preventing from page reload and default actions
                event.preventDefault();

                // serialize the data for sending the form data.
                let data = $(this).serialize();

                // make POST ajax call
                $.ajax({
                    type: 'POST',
                    url: "{% url 'create_todo' %}",
                    data: data,
                    dataType: 'json',
                    success: function (response, status) {

                        console.log(status);
                        $("#id_form").trigger('reset');

                        let instance = JSON.parse(response["data"]);
                        let fields = instance[0]["fields"];

                        get_all_todos(fields, "id_todos");
                    },
                });
            });
            */
        </script>
    <!-- END: VALIDAÇÃO DE USUÁRIO -->
{% endblock %}

